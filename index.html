<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>World Market Map - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏•‡∏Å</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;700&display=swap" rel="stylesheet">
        
    <style>
        /* üí° ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dark Mode/Light Mode (Variables) */
        :root {
            --bg-color: #f4f7f9; 
            --card-bg: #ffffff;
            --text-color: #333333;
            --open-color: #28a745; /* Green */
            --closed-color: #dc3545; /* Red */
            --near-color: #ffc107; /* Yellow */
            --border-color: #e0e0e0;
            --toggle-bg: #ccc;
            --toggle-bg-checked: #2196F3;
            
            /* Desktop Variables */
            --legend-height-px: 35px;       
            --legend-font-size-desktop: 0.8em; 
            
            /* üí° Spacing Variables */
            --header-gap-normal: 10px; 
            --header-gap-double: 20px; 
        }
        body.dark-mode {
            --bg-color: #1e2124; 
            --card-bg: #2d3135;
            --text-color: #f1f1f1;
            --border-color: #444444;
            --light-text-color: #b0b0b0; 
            --toggle-bg: #555;
            --toggle-bg-checked: #0b7dda;
        }
        
        /* üõ†Ô∏è CSS Layout (Flexbox Container for full height) */
        html, body {
            height: 100vh; 
            margin: 0;
            padding: 0;
            font-size: 16px; 
            font-family: 'Chakra Petch', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* üí° HEADER */
        .header {
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
            box-sizing: border-box;
            background-color: var(--card-bg);
            padding: 15px 40px; 
            border-bottom: 1px solid var(--border-color);
            z-index: 1000; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
            flex-shrink: 0; 
        }

        /* üí° Spacing */
        .header-top, .time-display, .mode-toggle-control {
            margin-bottom: var(--header-gap-normal); 
        }
        
        /* üö® V6.5 FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö Toggle Switch */
        .mode-toggle-control {
            margin-bottom: var(--header-gap-double); 
            display: flex; 
            align-items: center;
            /* ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤ 25px ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î */
            gap: 25px; 
        }

        .header h1 {
            margin: 0;
        }


        /* üí° Legend Bar & Icon */
        .legend-bar {
            width: 100%;
            height: var(--legend-height-px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            color: var(--text-color);
            font-size: var(--legend-font-size-desktop); 
            padding: 5px 0 0 0; 
            margin-top: calc(-1 * var(--header-gap-normal)); 
            margin-bottom: 5px; 
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px; 
        }

        /* üî¥ ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Legend */
        .legend-icon {
            width: 12px; 
            height: 12px;
            border-radius: 50%; 
            display: inline-block;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
            flex-shrink: 0; 
        }
        
        .legend-icon.open-icon { background-color: var(--open-color); }
        .legend-icon.closed-icon { background-color: var(--closed-color); }
        .legend-icon.near-icon { background-color: var(--near-color); }


        /* üí° Toggle Switch CSS (V6.6 FIX: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px; 
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--toggle-bg); transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px;
            bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
        }
        /* üö® FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏° background-color ‡πÅ‡∏•‡∏∞ transform ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
        input:checked + .slider { background-color: var(--toggle-bg-checked); } 
        input:checked + .slider:before { transform: translateX(26px); }


        /* üí° Map Container */
        #mapid {
            flex-grow: 1; 
            width: 100%;
            background-color: var(--bg-color); 
            z-index: 1; 
            position: relative; 
        }
        
        /* üí° MARKET CLOSED BANNER */
        .closed-banner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #dc3545; /* Red */
            color: white;
            text-align: center;
            padding: 8px 0;
            font-weight: 700;
            z-index: 1000; 
            transition: opacity 0.3s;
            display: none; 
        }
        .closed-banner.show {
            display: block;
        }

        /* üåü FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Z-INDEX ‡∏Ç‡∏≠‡∏á Marker Pane ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (V5.7) */
        .leaflet-marker-pane {
             z-index: 900 !important; 
             /* CRITICAL FIX: ‡∏ö‡∏≠‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Transform */
             will-change: transform, opacity; 
        }
        
        /* üí° Marker Icon (The Container of the Dot) */
        .market-icon-container {
            width: 20px !important; 
            height: 20px !important;
            box-sizing: border-box; 
            z-index: 900 !important; 
            border: none; 
            cursor: pointer; 
            display: flex;
            justify-content: center;
            align-items: center;
            /* CRITICAL FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Hardware Acceleration ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Marker Element */
            transform: translate3d(0, 0, 0); 
        }

        /* üí° The Actual Dot */
        .market-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: transform 0.2s; 
            /* üí° IMPORTANT: ‡∏™‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏ß‡∏¢ Inline Style: background-color: var(--open-color); */
        }
        
        /* üåü FIX: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Z-INDEX ‡∏Ç‡∏≠‡∏á Element Icon ‡∏Ç‡∏≠‡∏á Leaflet (V5.7) */
        .leaflet-marker-icon.market-icon-container {
            z-index: 900 !important; 
            opacity: 1.0 !important;
            /* CRITICAL FIX: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
            will-change: transform; 
        }

        /* üí° HOVER EFFECT KEYFRAMES (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
        @keyframes pulse-float {
            0% { transform: scale(1.0); box-shadow: 0 0 5px 0 rgba(255, 255, 255, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8); }
            100% { transform: scale(1.0); box-shadow: 0 0 5px 0 rgba(255, 255, 255, 0.5); }
        }

        /* üí° HOVER EFFECT APPLIED (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Container) */
        .leaflet-marker-icon:hover .market-dot {
             animation: pulse-float 1.2s infinite ease-in-out; 
             cursor: pointer; 
        }
        
        /* üí° FINAL FIX: ‡∏•‡∏ö Focus Outline ‡∏™‡∏µ‡πÅ‡∏î‡∏á/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÉ‡∏ô Leaflet Pane (‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î) */
        .leaflet-pane a:focus, 
        .leaflet-pane *:focus,
        .leaflet-container a:focus,
        .leaflet-container *:focus { 
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* üí° NEW FIX: Z-index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tooltip Pane */
        .leaflet-tooltip-pane {
             z-index: 1000 !important; /* ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Marker Pane (900) */
        }

        /* üí° ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tooltip (‡πÅ‡∏ó‡∏ô Popup) */
        .leaflet-tooltip {
             padding: 0; 
             margin: 0; 
             opacity: 0.95 !important;
             background-color: transparent !important; 
             border: none !important; 
             /* üö® CRITICAL FIX: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ Tooltip ‡∏£‡∏±‡∏ö Pointer Events ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Sticky */
             pointer-events: auto !important; 
        }
        
        /* üí° ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tooltip */
        .leaflet-tooltip-pane .market-tooltip-content {
            font-family: 'Chakra Petch', sans-serif;
            font-size: 0.9em;
            background-color: var(--card-bg); 
            color: var(--text-color);
            padding: 10px 12px; 
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            white-space: nowrap; 
            z-index: 1000; 
        }
        
        /* üí° ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
        .leaflet-top.leaflet-right {
            top: auto; 
            padding-top: 10px; 
        }
        
        /* üí° Footer */
        .footer {
            width: 100%;
            background-color: var(--card-bg);
            color: var(--text-color);
            text-align: center;
            padding: 5px 0;
            font-size: 0.8em;
            border-top: 1px solid var(--border-color);
            z-index: 1000; 
            opacity: 0.8;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0; 
        }
        
        /* üí° Media Query ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mobile */
        @media (max-width: 768px) {
            
            :root {
                --header-gap-normal: 8px; 
                --header-gap-double: 16px; 
                --legend-height-px: 30px; 
                --legend-font-size-desktop: 0.7em; 
            }
            
            .header {
                 padding: 10px 15px;
            }
            
            .leaflet-top.leaflet-right {
                padding-top: 5px; 
                right: 5px; 
            }
            
            .closed-banner {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body class="dark-mode"> 

    <div class="header" id="mainHeader">
        <div class="header-top">
            <h1>üåé World Market Map</h1> 
        </div>
        
        <div class="time-display">
            üáπüá≠ <span id="current-date"></span>, ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-time"></span>
        </div>

        <div class="mode-toggle-control">
            <span id="modeStatusText">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle" checked> 
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="legend-bar">
            <div class="legend-item">
                <div class="legend-icon open-icon"></div>
                <span>**‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß**: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Open)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon closed-icon"></div>
                <span>**‡∏™‡∏µ‡πÅ‡∏î‡∏á**: ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Closed)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon near-icon"></div>
                <span>**‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á**: ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (Near/Break)</span>
            </div>
        </div>
    </div>
    
    <div id="mapid">
        <div class="closed-banner" id="closedBanner">
            üö® **‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£**! ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
        </div>
    </div>

    <div class="footer">
        2025 Copyright/Developer by thetylerlab
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        
    <script>
        // üí° ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Default Leaflet Icons
        delete L.Icon.Default.prototype._getIconUrl; 
        
        // Data for major stock exchanges (Time is in GMT+7)
        const markets = [
            // === ‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢/‡πÅ‡∏õ‡∏ã‡∏¥‡∏ü‡∏¥‡∏Å ===
            { id: 'SET', name: 'Bangkok (‡πÑ‡∏ó‡∏¢)', exchange: 'SET', lat: 13.7563, lon: 100.5018, open: '10:00', close: '16:30', breakStart: '12:30', breakEnd: '14:00', dst: false },
            { id: 'TSE', name: 'Tokyo (JP)', exchange: 'TSE (Nikkei 225)', lat: 35.6895, lon: 139.6917, open: '07:00', close: '13:00', breakStart: '09:30', breakEnd: '10:30', dst: false },
            { id: 'KSE', name: 'Seoul (KR)', exchange: 'KSE (KOSPI)', lat: 37.5665, lon: 126.9780, open: '07:00', close: '13:30', breakStart: '', breakEnd: '', dst: false },
            { id: 'HKEX', name: 'Hong Kong (HK)', exchange: 'HKEX (Hang Seng)', lat: 22.3193, lon: 114.1694, open: '08:30', close: '15:00', breakStart: '11:00', breakEnd: '12:00', dst: false },
            { id: 'SSE', name: 'Shanghai (CN)', exchange: 'SSE (Shanghai)', lat: 31.2304, lon: 121.4737, open: '08:30', close: '14:00', breakStart: '10:30', breakEnd: '12:00', dst: false },
            { id: 'ASX', name: 'Sydney (AU)', exchange: 'ASX', lat: -33.8688, lon: 151.2093, open: '07:00', close: '13:00', breakStart: '', breakEnd: '', dst: false }, 
            { id: 'BSE', name: 'Mumbai (IN)', exchange: 'BSE (Sensex)', lat: 18.9750, lon: 72.8258, open: '10:30', close: '17:00', breakStart: '', breakEnd: '', dst: false },
            
            // === ‡∏¢‡∏∏‡πÇ‡∏£‡∏õ/‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏•‡∏≤‡∏á/‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤ ===
            { id: 'LSE', name: 'London (UK)', exchange: 'LSE (FTSE 100)', lat: 51.5074, lon: 0.1278, openSummer: '14:00', closeSummer: '22:30', openWinter: '15:00', closeWinter: '23:30', dst: true },
            { id: 'XETRA', name: 'Frankfurt (DE)', exchange: 'XETRA (DAX)', lat: 50.1109, lon: 8.6821, openSummer: '14:00', closeSummer: '22:30', openWinter: '15:00', closeWinter: '23:30', dst: true },
            { id: 'SAX', name: 'Stockholm (SE)', exchange: 'SAX (OMX)', lat: 59.3293, lon: 18.0686, openSummer: '14:00', closeSummer: '22:30', openWinter: '15:00', closeWinter: '23:30', dst: true },
            { id: 'TASE', name: 'Tel Aviv (IL)', exchange: 'TASE (TA-35)', lat: 32.0853, lon: 34.7818, open: '13:30', close: '23:30', breakStart: '', breakEnd: '', dst: false }, 
            { id: 'TADAWUL', name: 'Riyadh (SA)', exchange: 'Tadawul', lat: 24.7136, lon: 46.6069, open: '14:00', close: '21:00', breakStart: '', breakEnd: '', dst: false },
            
            // === ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡πÉ‡∏ï‡πâ ===
            { id: 'NYSE', name: 'New York (US)', exchange: 'NYSE / NASDAQ', lat: 40.7128, lon: -74.0060, openSummer: '20:30', closeSummer: '03:00', openWinter: '21:30', closeWinter: '04:00', dst: true },
            { id: 'TSX', name: 'Toronto (CA)', exchange: 'TSX', lat: 43.6532, lon: -79.3832, openSummer: '20:30', closeSummer: '03:00', openWinter: '21:30', closeWinter: '04:00', dst: true },
            { id: 'BMV', name: 'Mexico City (MX)', exchange: 'BMV', lat: 19.4326, lon: -99.1332, openSummer: '20:30', closeSummer: '03:00', openWinter: '21:30', closeWinter: '04:00', dst: true }, 
            { id: 'B3', name: 'S√£o Paulo (BR)', exchange: 'B3 (Ibovespa)', lat: -23.5505, lon: -46.6333, openSummer: '20:00', closeSummer: '03:00', openWinter: '21:00', closeWinter: '04:00', dst: true }, 
        ];

        // üí° Tile Layer URLs
        const lightMapTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'; 
        const darkMapTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'; 

        let mymap;
        let currentTileLayer;
        const marketMarkers = {};
        let stickyTooltip = null; 

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Time Calculation (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function isDST(date) { 
            const year = date.getFullYear();
            const getSunday = (month, n) => {
                let d = new Date(year, month, 1);
                let count = 0;
                while (count < n) {
                    if (d.getDay() === 0) count++;
                    if (count === n) return d;
                    d.setDate(d.getDate() + 1);
                }
            };
            const secondSundayMarch = getSunday(2, 2); 
            const firstSundayNovember = getSunday(10, 1); 
            return (date >= secondSundayMarch && date < firstSundayNovember);
        }

        function getTimeObject(timeStr, baseDate) { 
            const [hours, minutes] = timeStr.split(':').map(Number);
            let marketTime = new Date(baseDate); 
            marketTime.setHours(hours, minutes, 0, 0);
            return marketTime;
        }

        function formatTimeDiff(diffMs) { 
            if (diffMs < 0) return '00:00:00';
            const totalSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor((totalSeconds / 3600) % 24); 
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')} ‡∏ä‡∏°. ${String(minutes).padStart(2, '0')} ‡∏ô. ${String(seconds).padStart(2, '0')} ‡∏ß.`;
        }
        
        function getMarketStatus(market, now) { 
            const dayOfWeek = now.getDay(); 
            let openTimeStr, closeTimeStr, breakStartStr, breakEndStr;
            let currentDST = market.dst ? isDST(now) : false;
            let dstStatus = market.dst ? (currentDST ? '‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô (DST)' : '‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß') : '';
            
            // 1. ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 
            if (dayOfWeek === 0 || dayOfWeek === 6) { 
                let nextOpenTime = new Date(now);
                nextOpenTime.setDate(now.getDate() + (dayOfWeek === 0 ? 1 : 2)); 

                const defaultOpenTimeStr = market.open || market.openWinter || market.openSummer;
                if(defaultOpenTimeStr) {
                    const [h, m] = defaultOpenTimeStr.split(':').map(Number); 
                    nextOpenTime.setHours(h, m || 0, 0, 0);
                } else {
                    nextOpenTime = new Date(now);
                    nextOpenTime.setDate(now.getDate() + (dayOfWeek === 0 ? 1 : 2)); 
                    nextOpenTime.setHours(10, 0, 0, 0); 
                }
                
                const diffMs = nextOpenTime - now;
                return { 
                    status: '‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)', 
                    countdownText: `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå${defaultOpenTimeStr ? ` ‡πÄ‡∏ß‡∏•‡∏≤ ${defaultOpenTimeStr}` : ''} ‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`, 
                    statusClass: 'closed', 
                    tradingHours: '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‚Äì ‡∏®‡∏∏‡∏Å‡∏£‡πå' + (market.breakStart ? ' (‡∏°‡∏µ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô)' : ''),
                    dstStatus,
                    isClosed: true
                };
            }
            
            // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
            if (market.dst) {
                openTimeStr = currentDST ? market.openSummer : market.openWinter;
                closeTimeStr = currentDST ? market.closeSummer : market.closeWinter;
            } else {
                openTimeStr = market.open;
                closeTimeStr = market.close;
            }
            
            breakStartStr = market.breakStart;
            breakEndStr = market.breakEnd;

            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            let openTime = getTimeObject(openTimeStr, now);
            let closeTime = getTimeObject(closeTimeStr, now);
            let breakStartTime, breakEndTime;
            
            if (breakStartStr && breakEndStr) {
                 breakStartTime = getTimeObject(breakStartStr, now);
                 breakEndTime = getTimeObject(breakEndStr, now);
            }
            
            let status, countdownText, statusClass;
            let diffMs;
            let tradingHours = `${openTimeStr} ‚Äì ${closeTimeStr} ‡∏ô.`;
            if (breakStartStr) tradingHours += ` (‡∏û‡∏±‡∏Å ${breakStartStr} ‚Äì ${breakEndStr} ‡∏ô.)`;
            
            // 4. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (Overnight Market - CORE LOGIC FIX)
            const isOvernight = openTime.getTime() > closeTime.getTime();
            
            if (isOvernight) {
                if (now.getTime() >= openTime.getTime() || now.getTime() < closeTime.getTime()) {
                    closeTime.setDate(closeTime.getDate() + 1); 
                }
            } else { 
                // ‡∏ï‡∏•‡∏≤‡∏î Daytime
                 if (now.getTime() > closeTime.getTime()) { 
                    openTime.setDate(openTime.getDate() + 1);
                 }
            }
            
            // 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô 
            if (breakStartTime && breakEndTime) {
                 if (breakStartTime.getTime() > breakEndTime.getTime()) { 
                    if (now.getTime() < breakStartTime.getTime()) {
                         breakEndTime.setDate(breakEndTime.getDate() + 1);
                    }
                 }
            }
            
            // 6. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            const isDuringBreak = breakStartTime && breakEndTime && now >= breakStartTime && now < breakEndTime;
            const isOpen = now >= openTime && now < closeTime && !isDuringBreak;
            
            let nextOpenTime = openTime; 
            
            if (isOpen) {
                diffMs = closeTime - now;
                status = '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£';
                statusClass = 'open';
                countdownText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î: ${formatTimeDiff(diffMs)}`;
            } else if (isDuringBreak) {
                diffMs = breakEndTime - now;
                status = '‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô';
                statusClass = 'near';
                countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô: ${formatTimeDiff(diffMs)}`;
                nextOpenTime = breakEndTime; 
            } else {
                // 7. ‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏¥‡∏î (Closed) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Next Open Time
                status = '‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£';
                statusClass = 'closed';

                if (openTime.getTime() <= now.getTime()) {
                    let tempOpen = getTimeObject(openTimeStr, now);
                    tempOpen.setDate(tempOpen.getDate() + 1); 
                    
                    if (dayOfWeek === 5) {
                        tempOpen.setDate(tempOpen.getDate() + 2); 
                    } else if (dayOfWeek === 4 && isOvernight && now.getHours() < 12) { 
                         tempOpen.setDate(tempOpen.getDate() + 2);
                    }

                    nextOpenTime = tempOpen;
                } else {
                    nextOpenTime = openTime;
                }
                
                diffMs = nextOpenTime - now; 
                
                if ((dayOfWeek === 5 && now.getTime() > closeTime.getTime()) || 
                    (dayOfWeek === 4 && isOvernight && now.getHours() < 12)) {
                     countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`;
                }
                else {
                     countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`;
                }
            }

            const fifteenMinutes = 15 * 60 * 1000;
            if (isOpen && diffMs <= fifteenMinutes) {
                status = '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                statusClass = 'near';
            } else if (!isOpen && diffMs <= fifteenMinutes && diffMs > 0) {
                status = 'üîî ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                statusClass = 'near';
            }
            
            return { 
                status, 
                countdownText, 
                statusClass, 
                tradingHours: `‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‚Äì ‡∏®‡∏∏‡∏Å‡∏£‡πå (${tradingHours})`, 
                dstStatus,
                isClosed: statusClass === 'closed' 
            };
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (V6.2 FIX: determineInitialView) ---
        function determineInitialView() {
            const targetLat = 13.7563; 
            const targetLon = 100.5018; 
            const targetZoom = 2; 
            
            return { lat: targetLat, lon: targetLon, zoom: targetZoom }; 
        }

        function setZoomControlPosition() {
            const header = document.getElementById('mainHeader');
            const headerHeight = header.offsetHeight;
            const zoomControl = document.querySelector('.leaflet-top.leaflet-right');
            
            if (zoomControl) {
                zoomControl.style.top = `${headerHeight + 10}px`; 
            }
        }

        function initMap() {
             const initialView = determineInitialView();

             mymap = L.map('mapid', {
                center: [initialView.lat, initialView.lon], 
                zoom: initialView.zoom, 
                zoomControl: true, 
                maxZoom: 10, 
                minZoom: 1, 
                // V6.2: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡πÇ‡∏•‡∏Å
                worldCopyJump: true, 
                dragging: true, 
             }); 

             mymap.zoomControl.setPosition('topright'); 

             setMapTileLayer(document.body.classList.contains('dark-mode'));
             
             setTimeout(() => {
                 mymap.invalidateSize(true); 
                 setZoomControlPosition();
             }, 100); 
             
             setZoomControlPosition();

             updateDashboardMap();
             // üí° Call updateDashboardMap every 1 second
             setInterval(updateDashboardMap, 1000); 

             mymap.on('click', function(e) {
                if (stickyTooltip) {
                    let markerToUnstick = null;
                    for (const id in marketMarkers) {
                        if (marketMarkers[id].getTooltip() === stickyTooltip) {
                            markerToUnstick = marketMarkers[id];
                            break;
                        }
                    }
                    
                    if (markerToUnstick) {
                        markerToUnstick.closeTooltip();
                        stickyTooltip = null;
                    }
                }
            });
        }

        function setMapTileLayer(isDarkMode) {
            const tileUrl = isDarkMode ? darkMapTile : lightMapTile;
            const modeText = document.getElementById('modeStatusText');
            
            if (currentTileLayer) {
                mymap.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(tileUrl, {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery ¬© <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(mymap);
            
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            if (modeText) {
                modeText.textContent = isDarkMode ? 'üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
            }
        }

        // üí° MODIFIED: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Marker (V6.4: Fix Auto-Open Tooltip)
        function updateDashboardMap() {
            if (!mymap) return;

            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }; 

            const timeElement = document.getElementById('current-time');
            const dateElement = document.getElementById('current-date'); 
            const closedBanner = document.getElementById('closedBanner');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('th-TH', timeOptions);
            }
            if (dateElement) {
                 dateElement.textContent = now.toLocaleDateString('th-TH', dateOptions);
            }
            
            let allMarketsClosed = true;
            
            const currentZoom = mymap.getZoom(); 
            const isZoomedOut = currentZoom <= 1.5; 

            markets.forEach(market => {
                const statusData = getMarketStatus(market, now);

                if (statusData.statusClass !== 'closed') {
                    allMarketsClosed = false; 
                }

                const markerId = market.id;
                const currentStatusClass = statusData.statusClass;
                
                let statusColorVar = '';
                if (currentStatusClass === 'open') statusColorVar = 'var(--open-color)'; 
                else if (currentStatusClass === 'closed') statusColorVar = 'var(--closed-color)'; 
                else statusColorVar = 'var(--near-color)'; 
                
                let statusColorHex = '';
                if (currentStatusClass === 'open') statusColorHex = '#28a745'; 
                else if (currentStatusClass === 'closed') statusColorHex = '#dc3545'; 
                else statusColorHex = '#ffc107'; 
                
                // üí° V6.3: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á Tooltip ‡πÄ‡∏õ‡πá‡∏ô 'right' ‡πÄ‡∏™‡∏°‡∏≠
                const tooltipDirection = 'right';
                const tooltipOffset = L.point(10, 0); 
                
                
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Marker ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                if (!marketMarkers[markerId]) {
                    const marketIcon = L.divIcon({
                        className: 'market-icon-container', 
                        html: `<div class="market-dot" style="background-color: ${statusColorVar};"></div>`, 
                        iconSize: [20, 20], 
                        iconAnchor: [10, 10] 
                    });

                    const marker = L.marker([market.lat, market.lon], { 
                        icon: marketIcon,
                        bubblingMouseEvents: false 
                    }).addTo(mymap);
                    marketMarkers[markerId] = marker;
                    
                    // 2. ‡∏ú‡∏π‡∏Å Tooltip ‡πÅ‡∏•‡∏∞ Event Handlers
                    const tooltipContent = `
                        <div class="market-tooltip-content">
                            <span style="font-weight: 700;">${market.name}</span> (${market.exchange})<br>
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="font-weight: 700; color: ${statusColorHex}">${statusData.status}</span><br>
                            ${statusData.countdownText}
                        </div>
                    `;

                     marker.bindTooltip(tooltipContent, {
                        permanent: false, 
                        direction: tooltipDirection, 
                        offset: tooltipOffset,
                        sticky: false, 
                        interactive: false, 
                        className: 'market-tooltip',
                    });
                    
                    // Event Handlers
                     marker.on('mouseover', function (e) {
                            if (this.getTooltip() !== stickyTooltip) {
                                this.openTooltip();
                            }
                        });

                        marker.on('mouseout', function (e) {
                             if (this.getTooltip() !== stickyTooltip) {
                                this.closeTooltip();
                            }
                        });

                        marker.on('click', function (e) {
                             L.DomEvent.stop(e); 
                             
                             const currentTooltip = this.getTooltip();
                             
                             if (stickyTooltip === currentTooltip) {
                                  // UN-STICKY
                                  this.closeTooltip();
                                  stickyTooltip = null;
                             } else {
                                  // MAKE STICKY
                                  if (stickyTooltip) {
                                      let prevMarker = null;
                                      for (const id in marketMarkers) {
                                          if (marketMarkers[id].getTooltip() === stickyTooltip) {
                                              prevMarker = marketMarkers[id];
                                              break;
                                          }
                                      }
                                      if (prevMarker) {
                                           prevMarker.closeTooltip();
                                      }
                                  }
                                  
                                  stickyTooltip = currentTooltip;
                                  
                                  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateDashboardMap ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Tooltip ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
                                  updateDashboardMap(); 
                             }
                        });


                } else {
                    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Marker ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                    const marker = marketMarkers[markerId];
                    const markerElement = marker.getElement(); 

                    if (markerElement) {
                        const dotElement = markerElement.querySelector('.market-dot');
                        
                        if (dotElement) {
                            if (market.id === 'BMV' && isZoomedOut) {
                                // Skip update
                            } else {
                                dotElement.style.backgroundColor = statusColorVar;
                            }
                        }
                    }

                    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tooltip ‡πÄ‡∏™‡∏°‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Countdown Timer)
                     const tooltipContent = `
                        <div class="market-tooltip-content">
                            <span style="font-weight: 700;">${market.name}</span> (${market.exchange})<br>
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="font-weight: 700; color: ${statusColorHex}">${statusData.status}</span><br>
                            ${statusData.countdownText}
                        </div>
                    `;
                    
                    const tooltip = marker.getTooltip();
                    if (tooltip) {
                        tooltip.setContent(tooltipContent);
                        tooltip.options.direction = tooltipDirection;
                        tooltip.options.offset = tooltipOffset;

                        // üí° V6.4 FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Tooltip
                        if (tooltip === stickyTooltip) {
                            marker.openTooltip(); 
                        } else {
                            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î Tooltip ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á)
                            marker.closeTooltip(); 
                        }
                    }
                }
            });
            
            // üí° LOGIC FOR CLOSED BANNER 
            if (allMarketsClosed) {
                closedBanner.classList.add('show');
            } else {
                closedBanner.classList.remove('show');
            }
        }

        window.addEventListener('resize', () => {
             if (mymap) {
                 mymap.invalidateSize(true); 
                 setZoomControlPosition(); 
             }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
             initMap();
             
             const darkModeToggle = document.getElementById('darkModeToggle');
             darkModeToggle.addEventListener('change', () => {
                 const isChecked = darkModeToggle.checked;
                 setMapTileLayer(isChecked); 
                 if (mymap) {
                     setTimeout(() => {
                         mymap.invalidateSize(true);
                         setZoomControlPosition(); 
                     }, 50); 
                 }
             });
        });
    </script>
</body>
</html>