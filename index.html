<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"> 
    <title>World Market Map - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏•‡∏Å</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;700&display=swap" rel="stylesheet">
        
    <style>
        /* üí° ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dark Mode/Light Mode (Variables) */
        :root {
            --bg-color: #f4f7f9; 
            --card-bg: #ffffff;
            --text-color: #333333;
            --open-color: #28a745; 
            --closed-color: #dc3545; 
            --near-color: #ffc107; 
            --border-color: #e0e0e0;
            --toggle-bg: #ccc;
            --toggle-bg-checked: #007bff; 
            --legend-height-px: 35px;       
            --legend-font-size-desktop: 0.8em; 
            --header-gap-normal: 10px; 
            --header-gap-double: 20px; 

            .marker-cluster-small { background-color: rgba(0, 123, 255, 0.3); border: 1px solid rgba(0, 123, 255, 0.6); } 
            .marker-cluster-small div { background-color: rgba(0, 123, 255, 0.8); color: white; }
            .marker-cluster-medium { background-color: rgba(255, 193, 7, 0.3); border: 1px solid rgba(255, 193, 7, 0.6); } 
            .marker-cluster-medium div { background-color: rgba(255, 193, 7, 0.8); color: #333; }
            .marker-cluster-large { background-color: rgba(220, 53, 69, 0.3); border: 1px solid rgba(220, 53, 69, 0.6); } 
            .marker-cluster-large div { background-color: rgba(220, 53, 69, 0.8); color: white; }
        }
        
        body.dark-mode {
            --bg-color: #1a1a2e; 
            --card-bg: rgba(45, 49, 53, 0.95); 
            --text-color: #f1f1f1;
            --border-color: #3e4155; 
            --light-text-color: #b0b0b0; 
            --toggle-bg: #555;
            --toggle-bg-checked: #007bff;
            
            .marker-cluster-small { background-color: rgba(0, 123, 255, 0.3); border: 1px solid rgba(0, 123, 255, 0.6); } 
            .marker-cluster-small div { background-color: rgba(0, 123, 255, 0.8); color: white; }
            .marker-cluster-medium { background-color: rgba(255, 193, 7, 0.3); border: 1px solid rgba(255, 193, 7, 0.6); } 
            .marker-cluster-medium div { background-color: rgba(255, 193, 7, 0.8); color: #333; }
            .marker-cluster-large { background-color: rgba(220, 53, 69, 0.3); border: 1px solid rgba(220, 53, 69, 0.6); } 
            .marker-cluster-large div { background-color: rgba(220, 53, 69, 0.8); color: white; }
        }
        
        /* üõ†Ô∏è CSS Layout */
        html, body {
            height: 100vh; margin: 0; padding: 0; font-size: 16px; 
            font-family: 'Chakra Petch', sans-serif; 
            background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
            overflow: hidden; display: flex; flex-direction: column; 
        }
        
        .header {
            display: flex; flex-direction: column; align-items: flex-start;
            box-sizing: border-box; background-color: var(--card-bg);
            /* Default Desktop Padding */
            padding: 10px 40px; 
            border-bottom: 1px solid var(--border-color);
            z-index: 1000; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            transition: background-color 0.5s, color 0.5s, box-shadow 0.5s;
            flex-shrink: 0; 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); 
        }

        .header-main-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--header-gap-normal);
        }
        
        .header h1 { margin: 0; font-size: 1.8em; color: var(--toggle-bg-checked); }

        .header-controls-row {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 30px; 
            margin-bottom: var(--header-gap-normal);
        }
        
        .time-display { margin-bottom: 0; font-size: 0.9em; white-space: nowrap; flex-shrink: 0; }
        .mode-toggle-control { margin-bottom: 0; display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .search-control { margin-bottom: 0; width: 300px; flex-grow: 1; max-width: 400px; }
        .search-control input { padding: 8px 15px; width: 100%; border: 1px solid var(--border-color); border-radius: 20px; font-family: 'Chakra Petch', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s; }
        .search-control input:focus { outline: none; border-color: var(--toggle-bg-checked); box-shadow: 0 0 8px rgba(0, 123, 255, 0.5); background-color: var(--card-bg); }
        
        /* LEGEND BAR (Desktop) */
        .legend-bar { 
            width: 100%; 
            height: var(--legend-height-px); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 30px; 
            color: var(--text-color); 
            font-size: var(--legend-font-size-desktop); 
            padding: 5px 0 0 0; 
            margin-top: calc(-1 * var(--header-gap-normal)); 
            margin-bottom: 0; 
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-icon { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 3px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        .legend-icon.open-icon { background-color: var(--open-color); }
        .legend-icon.closed-icon { background-color: var(--closed-color); }
        .legend-icon.near-icon { background-color: var(--near-color); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--toggle-bg-checked); } 
        input:checked + .slider:before { transform: translateX(26px); }
        
        #mapid { flex-grow: 1; width: 100%; background-color: var(--bg-color); z-index: 1; position: relative; }
        .closed-banner { position: absolute; top: 0; left: 0; width: 100%; background-color: rgba(220, 53, 69, 0.9); color: white; text-align: center; padding: 8px 0; font-weight: 700; z-index: 1000; transition: opacity 0.3s; display: none; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
        .closed-banner.show { display: block; }
        .leaflet-marker-pane { z-index: 900 !important; will-change: transform, opacity; }
        .market-icon-container { width: 18px !important; height: 18px !important; box-sizing: border-box; z-index: 900 !important; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; transform: translate3d(0, 0, 0); }
        .market-dot { width: 18px; height: 18px; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); }
        @keyframes glow-pulse {
            0% { box-shadow: 0 0 0 0 currentColor, 0 0 5px rgba(0, 0, 0, 0.5); }
            50% { box-shadow: 0 0 10px 5px rgba(255, 255, 255, 0.5), 0 0 20px 8px rgba(255, 255, 255, 0.2); }
            100% { box-shadow: 0 0 0 0 currentColor, 0 0 5px rgba(0, 0, 0, 0.5); }
        }
        .market-icon-container:hover .market-dot { animation: glow-pulse 1.5s infinite ease-in-out; cursor: pointer; }
        .leaflet-tooltip-pane { z-index: 1000 !important; }
        .leaflet-tooltip { padding: 0; margin: 0; opacity: 0.98 !important; background-color: transparent !important; border: none !important; pointer-events: auto !important; }
        
        /* Tooltip Content (Horizontal Rectangle Look) */
        .leaflet-tooltip-pane .market-tooltip-content {
            font-family: 'Chakra Petch', sans-serif; font-size: 0.85em;
            background-color: var(--card-bg); color: var(--text-color);
            padding: 12px 15px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color); 
            max-width: 350px; 
            min-width: 250px; 
            white-space: normal;
            line-height: 1.4;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); 
        }

        /* Flexbox ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô */
        .tooltip-status-line {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px; 
            gap: 10px; 
        }
        
        .tooltip-time-info {
            font-size: 0.8em;
            opacity: 0.9;
            text-align: right;
            white-space: nowrap; 
        }
        .tooltip-time-info strong {
            font-weight: 500;
        }
        
        .footer {
            width: 100%; background-color: var(--card-bg); color: var(--text-color);
            text-align: center; padding: 5px 0; font-size: 0.75em; border-top: 1px solid var(--border-color);
            z-index: 1000; opacity: 0.7; transition: background-color 0.5s, color 0.5s; flex-shrink: 0; 
        }
        
        /* üí° Media Query for Mobile (UX/UI Adjustments) */
        @media (max-width: 768px) {
            /* üö® FINAL FIX: Force Safe Area Padding for Dynamic Island/Notch devices (Version 7.12) */
            .header { 
                 /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ padding ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà env() ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
                 padding-top: 25px !important; 
                 
                 /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Safe Area (‡∏£‡∏ß‡∏° padding ‡πÄ‡∏î‡∏¥‡∏° 10px + ‡∏Ñ‡πà‡∏≤ safe area) */
                 padding-top: calc(env(safe-area-inset-top) + 10px) !important; 
                 
                 padding-bottom: 10px; 
                 /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
                 padding-left: calc(env(safe-area-inset-left) + 15px) !important;
                 padding-right: calc(env(safe-area-inset-right) + 15px) !important;
            }
            
            .header-main-row {
                width: 100%;
                justify-content: space-between; 
                margin-bottom: var(--header-gap-normal);
            }
            
            .header h1 {
                 font-size: 1.5em; 
                 white-space: nowrap; 
            }

            .header-controls-row { 
                 flex-direction: column; 
                 align-items: flex-start;
                 gap: 10px; 
            }
            
            .search-control { width: 100%; max-width: 100%; }
            .time-display { order: 1; margin-bottom: 5px;}
            
            .mode-toggle-control {
                gap: 8px; 
            }
            
            .mode-toggle-control span#modeStatusText {
                font-size: 0.85em; 
                white-space: nowrap;
                flex-shrink: 0; 
            }
            
            /* Legend Bar */
            .legend-bar { 
                justify-content: flex-start; 
                gap: 10px 25px; 
                font-size: 0.75em; 
                padding: 10px 20px 10px 20px; 
                margin-top: 0; 
                height: auto; 
                flex-wrap: wrap; 
                box-sizing: border-box; 
            }
            .legend-item {
                 flex-shrink: 0; 
            }
        }
    </style>
</head>
<body> 

    <div class="header" id="mainHeader">
        <div class="header-main-row"> 
            <h1>üåé World Market Map</h1> 
            <div class="mode-toggle-control">
                <span id="modeStatusText">‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle"> 
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <div class="header-controls-row">
            <div class="time-display">
                üáπüá≠ <span id="current-date"></span>, ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-time"></span>
            </div>
            <div class="search-control">
                 <input type="text" id="marketSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏∏‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Tokyo, NYSE)...">
            </div>
        </div>
        
        <div class="legend-bar">
            <div class="legend-item"><div class="legend-icon open-icon"></div><span>**‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß**: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</span></div>
            <div class="legend-item"><div class="legend-icon closed-icon"></div><span>**‡∏™‡∏µ‡πÅ‡∏î‡∏á**: ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</span></div>
            <div class="legend-item"><div class="legend-icon near-icon"></div><span>**‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á**: ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</span></div>
        </div>
    </div>
    
    <div id="mapid">
        <div class="closed-banner" id="closedBanner">
            üö® **‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£**! ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
        </div>
    </div>

    <div class="footer">
        2025 Copyright/Developer by thetylerlab | Version 7.12 (Final Notch/Safe-Area Force Fix)
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data-10-year-range.min.js"></script>
        
    <script>
        // [JavaScript Code - Unchanged logic]
        delete L.Icon.Default.prototype._getIconUrl; 
        
        const marketHolidays = {
            'SET': ['2025-10-23', '2025-12-05', '2025-12-10'], 
            'NYSE': ['2025-01-01', '2025-01-20', '2025-05-26'], 
            'TSE': ['2025-01-01', '2025-01-13', '2025-02-11'], 
        };
        
        const markets = [
            { id: 'SET', name: 'Bangkok (‡πÑ‡∏ó‡∏¢)', exchange: 'SET', lat: 13.7563, lon: 100.5018, open: '10:00', close: '16:30', breakStart: '12:30', breakEnd: '14:00', dst: false, timezone: 'Asia/Bangkok' },
            { id: 'TSE', name: 'Tokyo (JP)', exchange: 'TSE (Nikkei 225)', lat: 35.6895, lon: 139.6917, open: '09:00', close: '15:00', breakStart: '11:30', breakEnd: '12:30', dst: false, timezone: 'Asia/Tokyo' }, 
            { id: 'KSE', name: 'Seoul (KR)', exchange: 'KSE (KOSPI)', lat: 37.5665, lon: 126.9780, open: '09:00', close: '15:30', breakStart: '', breakEnd: '', dst: false, timezone: 'Asia/Seoul' }, 
            { id: 'HKEX', name: 'Hong Kong (HK)', exchange: 'HKEX (Hang Seng)', lat: 22.3193, lon: 114.1694, open: '09:30', close: '16:00', breakStart: '12:00', breakEnd: '13:00', dst: false, timezone: 'Asia/Hong_Kong' }, 
            { id: 'SSE', name: 'Shanghai (CN)', exchange: 'SSE (Shanghai)', lat: 31.2304, lon: 121.4737, open: '09:30', close: '15:00', breakStart: '11:30', breakEnd: '13:00', dst: false, timezone: 'Asia/Shanghai' },
            { id: 'ASX', name: 'Sydney (AU)', exchange: 'ASX', lat: -33.8688, lon: 151.2093, open: '10:00', close: '16:00', breakStart: '', breakEnd: '', dst: true, timezone: 'Australia/Sydney' }, 
            { id: 'BSE', name: 'Mumbai (IN)', exchange: 'BSE (Sensex)', lat: 18.9750, lon: 72.8258, open: '09:15', close: '15:30', breakStart: '', breakEnd: '', dst: false, timezone: 'Asia/Kolkata' },
            { id: 'IDX', name: 'Jakarta (ID)', exchange: 'IDX', lat: -6.1754, lon: 106.8272, open: '09:00', close: '16:00', breakStart: '12:00', breakEnd: '13:30', dst: false, timezone: 'Asia/Jakarta' },
            { id: 'LSE', name: 'London (UK)', exchange: 'LSE (FTSE 100)', lat: 51.5074, lon: 0.1278, open: '08:00', close: '16:30', breakStart: '', breakEnd: '', dst: true, timezone: 'Europe/London' },
            { id: 'XETRA', name: 'Frankfurt (DE)', exchange: 'XETRA (DAX)', lat: 50.1109, lon: 8.6821, open: '09:00', close: '17:30', breakStart: '', breakEnd: '', dst: true, timezone: 'Europe/Berlin' },
            { id: 'JSE', name: 'Johannesburg (ZA)', exchange: 'JSE', lat: -26.2041, lon: 28.0473, open: '09:00', close: '17:00', breakStart: '', breakEnd: '', dst: false, timezone: 'Africa/Johannesburg' },
            { id: 'TASE', name: 'Tel Aviv (IL)', exchange: 'TASE (TA-35)', lat: 32.0853, lon: 34.7818, open: '09:45', close: '16:30', breakStart: '', breakEnd: '', dst: true, timezone: 'Asia/Jerusalem' }, 
            { id: 'TADAWUL', name: 'Riyadh (SA)', exchange: 'Tadawul', lat: 24.7136, lon: 46.6069, open: '10:00', close: '15:00', breakStart: '', breakEnd: '', dst: false, timezone: 'Asia/Riyadh' },
            { id: 'NYSE', name: 'New York (US)', exchange: 'NYSE / NASDAQ', lat: 40.7128, lon: -74.0060, open: '09:30', close: '16:00', breakStart: '', breakEnd: '', dst: true, timezone: 'America/New_York' },
            { id: 'TSX', name: 'Toronto (CA)', exchange: 'TSX', lat: 43.6532, lon: -79.3832, open: '09:30', close: '16:00', breakStart: '', breakEnd: '', dst: true, timezone: 'America/Toronto' },
            { id: 'BMV', name: 'Mexico City (MX)', exchange: 'BMV', lat: 19.4326, lon: -99.1332, open: '08:30', close: '15:00', breakStart: '', breakEnd: '', dst: true, timezone: 'America/Mexico_City' }, 
            { id: 'B3', name: 'S√£o Paulo (BR)', exchange: 'B3 (Ibovespa)', lat: -23.5505, lon: -46.6333, open: '10:00', close: '17:00', breakStart: '', breakEnd: '', dst: true, timezone: 'America/Sao_Paulo' }, 
            { id: 'MOEX', name: 'Moscow (RU)', exchange: 'MOEX', lat: 55.7558, lon: 37.6173, open: '09:50', close: '18:50', breakStart: '', breakEnd: '', dst: false, timezone: 'Europe/Moscow' },
            { id: 'EURONEXT', name: 'Paris (FR)', exchange: 'Euronext', lat: 48.8566, lon: 2.3522, open: '09:00', close: '17:30', breakStart: '', breakEnd: '', dst: true, timezone: 'Europe/Paris' },
            { id: 'SIX', name: 'Zurich (CH)', exchange: 'SIX', lat: 47.3769, lon: 8.5417, open: '09:00', close: '17:30', breakStart: '', breakEnd: '', dst: true, timezone: 'Europe/Zurich' },
        ];

        let mymap;
        let currentTileLayer;
        const marketMarkers = {};
        let stickyTooltip = null; 
        let markerClusterGroup; 

        function formatTimeDiff(diffMs) { 
            if (diffMs < 0) return '00:00:00';
            const totalSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor(totalSeconds / 3600); 
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours} ‡∏ä‡∏°.`);
            parts.push(`${String(minutes).padStart(2, '0')} ‡∏ô.`);
            parts.push(`${String(seconds).padStart(2, '0')} ‡∏ß.`);
            
            return parts.join(' ');
        }
        
        function getMarketStatus(market) { 
            const nowInMarketZone = moment().tz(market.timezone);
            const dayOfWeek = nowInMarketZone.day(); 
            const todayDateStr = nowInMarketZone.format('YYYY-MM-DD');
            const openTimeStr = market.open;
            const closeTimeStr = market.close;
            const breakStartStr = market.breakStart;
            const breakEndStr = market.breakEnd;
            
            let status, countdownText, statusClass;
            let diffMs;
            let nextOpen = null; 

            const holidays = marketHolidays[market.id] || [];
            const isHoliday = holidays.includes(todayDateStr);
            
            if (isHoliday) {
                let nextWorkingDay = nowInMarketZone.clone().add(1, 'day');
                while (nextWorkingDay.day() === 0 || nextWorkingDay.day() === 6 || holidays.includes(nextWorkingDay.format('YYYY-MM-DD'))) {
                    nextWorkingDay.add(1, 'day');
                }
                
                const [h, m] = market.open.split(':')[0] ? market.open.split(':').map(Number) : [9, 0];
                nextOpen = nextWorkingDay.set({ hour: h, minute: m, second: 0, millisecond: 0 });
                diffMs = nextOpen.diff(nowInMarketZone);
                
                return { 
                    status: '‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)', 
                    countdownText: `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô${nextOpen.format('dd')} ‡πÄ‡∏ß‡∏•‡∏≤ ${market.open} ‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`, 
                    statusClass: 'closed', 
                    tradingHours: `${openTimeStr} ‚Äì ${closeTimeStr} ‡∏ô. (${nowInMarketZone.zoneAbbr()})`,
                    localTime: nowInMarketZone.format('HH:mm:ss'),
                    isClosed: true
                };
            }

            if (dayOfWeek === 0 || dayOfWeek === 6) { 
                nextOpen = nowInMarketZone.clone().day(dayOfWeek === 0 ? 1 : 8); 
                while (nextOpen.day() === 0 || nextOpen.day() === 6 || holidays.includes(nextOpen.format('YYYY-MM-DD'))) {
                    nextOpen.add(1, 'day');
                }
                
                const [h, m] = market.open.split(':')[0] ? market.open.split(':').map(Number) : [9, 0];
                nextOpen.set({ hour: h, minute: m, second: 0, millisecond: 0 });
                const diff = nextOpen.diff(nowInMarketZone);
                
                return { 
                    status: '‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)', 
                    countdownText: `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô${nextOpen.format('dd')} ‡πÄ‡∏ß‡∏•‡∏≤ ${market.open} ‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diff)}`, 
                    statusClass: 'closed', 
                    tradingHours: `${openTimeStr} ‚Äì ${closeTimeStr} ‡∏ô. (${nowInMarketZone.zoneAbbr()})`,
                    localTime: nowInMarketZone.format('HH:mm:ss'),
                    isClosed: true
                };
            }

            let openTime = nowInMarketZone.clone().set({ hour: parseInt(openTimeStr.split(':')[0]), minute: parseInt(openTimeStr.split(':')[1]), second: 0, millisecond: 0 });
            let closeTime = nowInMarketZone.clone().set({ hour: parseInt(closeTimeStr.split(':')[0]), minute: parseInt(closeTimeStr.split(':')[1]), second: 0, millisecond: 0 });
            let breakStart = breakStartStr ? nowInMarketZone.clone().set({ hour: parseInt(breakStartStr.split(':')[0]), minute: parseInt(breakStartStr.split(':')[1]), second: 0, millisecond: 0 }) : null;
            let breakEnd = breakEndStr ? nowInMarketZone.clone().set({ hour: parseInt(breakEndStr.split(':')[0]), minute: parseInt(breakEndStr.split(':')[1]), second: 0, millisecond: 0 }) : null;

            if (openTime.isAfter(closeTime)) { 
                if (nowInMarketZone.isBefore(closeTime)) { openTime.subtract(1, 'day'); } else { closeTime.add(1, 'day'); }
            } else {
                 if (nowInMarketZone.isAfter(closeTime)) {
                    let nextWorkingDay = nowInMarketZone.clone().add(1, 'day');
                    while (nextWorkingDay.day() === 0 || nextWorkingDay.day() === 6 || holidays.includes(nextWorkingDay.format('YYYY-MM-DD'))) {
                        nextWorkingDay.add(1, 'day');
                    }
                    openTime = nextWorkingDay.clone().set({ hour: openTime.hour(), minute: openTime.minute(), second: 0, millisecond: 0 });
                    closeTime = nextWorkingDay.clone().set({ hour: closeTime.hour(), minute: closeTime.minute(), second: 0, millisecond: 0 });
                    breakStart = breakStart ? nextWorkingDay.clone().set({ hour: breakStart.hour(), minute: breakStart.minute(), second: 0, millisecond: 0 }) : null;
                    breakEnd = breakEnd ? nextWorkingDay.clone().set({ hour: breakEnd.hour(), minute: breakEnd.minute(), second: 0, millisecond: 0 }) : null;
                }
            }
            
            if (breakStart && breakEnd && breakStart.isAfter(breakEnd)) {
                 if (nowInMarketZone.isBefore(breakEnd)) { breakStart.subtract(1, 'day'); } else { breakEnd.add(1, 'day'); }
            }
            
            const isDuringBreak = breakStart && breakEnd && nowInMarketZone.isBetween(breakStart, breakEnd, null, '[]');
            const isOpen = nowInMarketZone.isBetween(openTime, closeTime, null, '[]') && !isDuringBreak;
            
            let nextEventTime;
            
            if (isOpen) {
                nextEventTime = isDuringBreak ? breakEnd : closeTime;
                diffMs = nextEventTime.diff(nowInMarketZone);
                status = '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£';
                statusClass = 'open';
                countdownText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î: ${formatTimeDiff(diffMs)}`;
            } else if (isDuringBreak) {
                nextEventTime = breakEnd;
                diffMs = nextEventTime.diff(nowInMarketZone);
                status = '‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô';
                statusClass = 'near';
                countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô: ${formatTimeDiff(diffMs)}`;
            } else {
                status = '‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£';
                statusClass = 'closed';
                nextEventTime = openTime; 
                diffMs = nextEventTime.diff(nowInMarketZone); 
                
                if (nextEventTime.day() === nowInMarketZone.day()) {
                    countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`;
                } else {
                    countdownText = `‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô${nextEventTime.format('dd')} ‡πÄ‡∏ß‡∏•‡∏≤ ${market.open} ‡∏≠‡∏µ‡∏Å: ${formatTimeDiff(diffMs)}`;
                }
            }

            const fifteenMinutes = moment.duration(15, 'minutes');
            if (!isOpen && nextEventTime.diff(nowInMarketZone) <= fifteenMinutes.asMilliseconds() && nextEventTime.diff(nowInMarketZone) > 0) {
                 status = 'üîî ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                 statusClass = 'near';
            } else if (isOpen && closeTime.diff(nowInMarketZone) <= fifteenMinutes.asMilliseconds() && !isDuringBreak) {
                status = '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                statusClass = 'near';
            }
            
            let tradingHours = `${market.open} ‚Äì ${market.close} ‡∏ô. (${nowInMarketZone.zoneAbbr()})`;
            if (market.breakStart) tradingHours += ` (‡∏û‡∏±‡∏Å ${market.breakStart} ‚Äì ${market.breakEnd} ‡∏ô.)`;
            if (market.dst) tradingHours += ` [${nowInMarketZone.isDST() ? 'DST' : 'Standard Time'}]`;
            
            const localTimeStr = nowInMarketZone.format('HH:mm:ss');

            return { status, countdownText, statusClass, tradingHours: tradingHours, localTime: localTimeStr, isClosed: statusClass === 'closed' };
        }


        function determineInitialView() { return { lat: 13.7563, lon: 100.5018, zoom: 2 }; }

        function setZoomControlPosition() {
            const header = document.getElementById('mainHeader');
            // header.offsetHeight ‡∏à‡∏∞‡∏£‡∏ß‡∏° padding ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å safe-area-inset-top ‡πÅ‡∏•‡πâ‡∏ß
            const headerHeight = header.offsetHeight; 
            const zoomControl = document.querySelector('.leaflet-top.leaflet-right');
            
            if (zoomControl) {
                // üí° ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Header ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö Safe Area ‡πÅ‡∏•‡πâ‡∏ß + 30px
                zoomControl.style.top = `${headerHeight + 30}px`; 
            }
        }

        function initMap() {
             const initialView = determineInitialView();

             mymap = L.map('mapid', {
                center: [initialView.lat, initialView.lon], zoom: initialView.zoom, zoomControl: true, 
                maxZoom: 10, minZoom: 1, worldCopyJump: true, dragging: true, 
             }); 
             
             markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 70, 
                disableClusteringAtZoom: 5, 
                chunkedLoading: true
             }).addTo(mymap);

             mymap.zoomControl.setPosition('topright'); 
             
             setMapTileLayer(document.body.classList.contains('dark-mode')); 
             
             // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ CSS Render ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Header
             setTimeout(() => {
                 mymap.invalidateSize(true); 
                 setZoomControlPosition();
             }, 100); 
             
             setZoomControlPosition();

             updateDashboardMap(true); 
             setInterval(() => updateDashboardMap(false), 1000); 

             mymap.on('click', function(e) {
                if (stickyTooltip) {
                    let markerToUnstick = null;
                    for (const id in marketMarkers) {
                        if (marketMarkers[id].getTooltip() === stickyTooltip) {
                            markerToUnstick = marketMarkers[id];
                            break;
                        }
                    }
                    if (markerToUnstick) {
                        markerToUnstick.closeTooltip();
                        stickyTooltip = null;
                    }
                }
            });
        }

        function setMapTileLayer(isDarkMode) {
            const lightMapTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'; 
            const darkMapTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'; 
            const tileUrl = isDarkMode ? darkMapTile : lightMapTile;
            const modeText = document.getElementById('modeStatusText');
            
            if (currentTileLayer) { mymap.removeLayer(currentTileLayer); }
            
            currentTileLayer = L.tileLayer(tileUrl, {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery ¬© <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(mymap);
            
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            if (modeText) {
                modeText.textContent = isDarkMode ? 'üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
            }
        }
        
        function updateDashboardMap(forceRedraw = false) { 
            if (!mymap) return;

            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }; 

            const timeElement = document.getElementById('current-time');
            const dateElement = document.getElementById('current-date'); 
            const closedBanner = document.getElementById('closedBanner');
            
            if (timeElement) { timeElement.textContent = now.toLocaleTimeString('th-TH', timeOptions); }
            if (dateElement) { dateElement.textContent = now.toLocaleDateString('th-TH', dateOptions); }
            
            let allMarketsClosed = true;
            
            markets.forEach(market => {
                const statusData = getMarketStatus(market); 

                if (statusData.statusClass !== 'closed') { allMarketsClosed = false; }

                const markerId = market.id;
                const currentStatusClass = statusData.statusClass;
                
                let statusColorVar, statusColorHex;
                if (currentStatusClass === 'open') { statusColorVar = 'var(--open-color)'; statusColorHex = '#28a745'; }
                else if (currentStatusClass === 'closed') { statusColorVar = 'var(--closed-color)'; statusColorHex = '#dc3545'; }
                else { statusColorVar = 'var(--near-color)'; statusColorHex = '#ffc107'; }
                
                // Tooltip Content for Horizontal Rectangle Readability
                const tooltipContent = `
                    <div class="market-tooltip-content">
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--toggle-bg-checked); margin-bottom: 5px;">${market.name}</div>
                        
                        <div class="tooltip-status-line">
                            <span style="color: ${statusColorHex}; font-weight: 700; white-space: nowrap;">${statusData.status}</span>
                            <span class="tooltip-time-info">
                                **‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô:** <strong>${statusData.localTime}</strong>
                            </span>
                        </div>
                        
                        <div>${statusData.countdownText}</div>
                        
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 8px 0;">
                        
                        <div class="tooltip-time-info" style="text-align: left; opacity: 1; font-size: 0.85em;">
                            **‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:** ${statusData.tradingHours}
                        </div>
                    </div>
                `;
                
                const tooltipDirection = 'right';
                const tooltipOffset = L.point(10, 0); 

                if (forceRedraw || !marketMarkers[markerId]) {
                    if (marketMarkers[markerId]) {
                         markerClusterGroup.removeLayer(marketMarkers[markerId]);
                         delete marketMarkers[markerId];
                    }
                    
                    const marketIcon = L.divIcon({
                        className: 'market-icon-container', 
                        html: `<div class="market-dot" style="background-color: ${statusColorVar}; color: ${statusColorVar};"></div>`, 
                        iconSize: [18, 18], 
                        iconAnchor: [9, 9] 
                    });

                    const marker = L.marker([market.lat, market.lon], { 
                        icon: marketIcon,
                        bubblingMouseEvents: false 
                    });
                    
                    markerClusterGroup.addLayer(marker);
                    marketMarkers[markerId] = marker;
                    
                    marker.bindTooltip(tooltipContent, {
                        permanent: false, direction: tooltipDirection, offset: tooltipOffset,
                        sticky: false, interactive: false, className: 'market-tooltip',
                    });
                    
                    marker.on('mouseover', function (e) {
                            if (this.getTooltip() !== stickyTooltip) { this.openTooltip(); }
                        });

                    marker.on('mouseout', function (e) {
                            if (this.getTooltip() !== stickyTooltip) { this.closeTooltip(); }
                        });

                    marker.on('click', function (e) {
                            L.DomEvent.stop(e); 
                            const currentTooltip = this.getTooltip();
                            
                            if (stickyTooltip === currentTooltip) {
                                this.closeTooltip();
                                stickyTooltip = null;
                            } else {
                                if (stickyTooltip) {
                                    let prevMarker = null;
                                    for (const id in marketMarkers) {
                                        if (marketMarkers[id].getTooltip() === stickyTooltip) {
                                            prevMarker = marketMarkers[id];
                                            break;
                                        }
                                    }
                                    if (prevMarker) { prevMarker.closeTooltip(); }
                                }
                                stickyTooltip = currentTooltip;
                                updateDashboardMap(false); 
                            }
                        });


                } else {
                    const marker = marketMarkers[markerId];
                    const markerElement = marker.getElement(); 

                    if (markerElement) {
                        const dotElement = markerElement.querySelector('.market-dot');
                        if (dotElement) {
                            dotElement.style.backgroundColor = statusColorVar;
                            dotElement.style.color = statusColorVar; 
                        }
                    }

                    const tooltip = marker.getTooltip();
                    if (tooltip) {
                        tooltip.setContent(tooltipContent);
                        if (tooltip === stickyTooltip) {
                            marker.openTooltip(); 
                        } else {
                            marker.closeTooltip(); 
                        }
                    }
                }
            });
            
            if (allMarketsClosed) {
                closedBanner.classList.add('show');
            } else {
                closedBanner.classList.remove('show');
            }
        }
        
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('marketSearch');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length > 0) {
                    const foundMarket = markets.find(m => 
                        m.name.toLowerCase().includes(query) || 
                        m.exchange.toLowerCase().includes(query) || 
                        m.id.toLowerCase() === query
                    );
                    
                    if (foundMarket) {
                        const marker = marketMarkers[foundMarket.id];
                        
                        if (markerClusterGroup && marker) {
                            markerClusterGroup.zoomToShowLayer(marker, function () {
                                mymap.setView([foundMarket.lat, foundMarket.lon], 5, { animation: true }); 
                            });
                        } else {
                             mymap.setView([foundMarket.lat, foundMarket.lon], 5, { animation: true }); 
                        }
                        
                        if (marker) {
                            if (stickyTooltip) {
                                let prevMarker = null;
                                for (const id in marketMarkers) {
                                    if (marketMarkers[id].getTooltip() === stickyTooltip) {
                                        prevMarker = marketMarkers[id];
                                        break;
                                    }
                                }
                                if (prevMarker) { prevMarker.closeTooltip(); }
                            }
                            
                            stickyTooltip = marker.getTooltip();
                            updateDashboardMap(false); 
                        }
                    }
                } else {
                    if (stickyTooltip) {
                        let markerToUnstick = null;
                        for (const id in marketMarkers) {
                            if (marketMarkers[id].getTooltip() === stickyTooltip) {
                                markerToUnstick = marketMarkers[id];
                                break;
                            }
                        }
                        if (markerToUnstick) {
                            markerToUnstick.closeTooltip();
                            stickyTooltip = null;
                        }
                    }
                }
            });
        }

        window.addEventListener('resize', () => {
             if (mymap) {
                 mymap.invalidateSize(true); 
                 setZoomControlPosition(); 
             }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
             initMap();
             setupSearchFunctionality(); 
             
             const darkModeToggle = document.getElementById('darkModeToggle');
             darkModeToggle.addEventListener('change', () => {
                 const isChecked = darkModeToggle.checked;
                 setMapTileLayer(isChecked); 
                 if (mymap) {
                     setTimeout(() => {
                         mymap.invalidateSize(true);
                         setZoomControlPosition(); 
                     }, 50); 
                 }
             });
        });
    </script>
</body>
</html>